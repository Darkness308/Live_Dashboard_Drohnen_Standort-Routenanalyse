name: Deployment Preview

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

jobs:
  build:
    name: Build Static Site
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Create build directory
        run: |
          mkdir -p build
          cp -r index.html assets build/
          cp -r .env.example build/
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-preview
          path: build/
          retention-days: 7

  deploy-preview:
    name: Deploy Preview to GitHub Pages
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-preview
          path: preview/
      
      - name: Deploy to GitHub Pages (Preview Branch)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create preview branch name
          PREVIEW_BRANCH="preview-pr-${{ github.event.pull_request.number }}"
          
          # Checkout preview branch (create if doesn't exist)
          git checkout -b $PREVIEW_BRANCH || git checkout $PREVIEW_BRANCH
          
          # Copy preview files
          cp -r preview/* .
          
          # Commit and push
          git add .
          git commit -m "Deploy preview for PR #${{ github.event.pull_request.number }}" || echo "No changes to commit"
          git push origin $PREVIEW_BRANCH --force
          
          echo "PREVIEW_BRANCH=$PREVIEW_BRANCH" >> $GITHUB_ENV
      
      - name: Comment Preview URL on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const previewUrl = `https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/`;
            const comment = `## ðŸš€ Deployment Preview
            
            Your preview deployment is ready!
            
            **Preview URL:** ${previewUrl}
            **Branch:** preview-pr-${{ github.event.pull_request.number }}
            
            ### How to view:
            1. Click the preview URL above
            2. You may need to wait 1-2 minutes for GitHub Pages to update
            3. Configure your Google Maps API key in the browser console or .env
            
            ### Note:
            - This preview does not include your API keys (for security)
            - Add your Google Maps API key via localStorage:
              \`\`\`javascript
              localStorage.setItem('GOOGLE_MAPS_API_KEY', 'your_key_here');
              \`\`\`
            - Then refresh the page
            
            ---
            ðŸ“ This preview will be updated automatically when you push new commits to this PR.
            ðŸ—‘ï¸ The preview branch will be cleaned up when the PR is closed.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  lighthouse:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-preview
          path: preview/
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          npm install -g @lhci/cli@0.13.x
          npm install -g http-server
      
      - name: Start HTTP Server
        run: |
          cd preview
          http-server . -p 8080 &
          sleep 5
      
      - name: Run Lighthouse CI
        run: |
          lhci autorun --collect.url=http://localhost:8080/index.html --collect.numberOfRuns=1 || true
        continue-on-error: true
      
      - name: Lighthouse Report
        if: always()
        run: |
          echo "Lighthouse audit completed. Check logs for performance scores."

  cross-browser-screenshots:
    name: Cross-Browser Screenshot Tests
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-preview
          path: preview/
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install Puppeteer
        run: |
          npm install puppeteer
      
      - name: Create Screenshot Script
        run: |
          cat > take-screenshots.js << 'EOF'
          const puppeteer = require('puppeteer');
          const http = require('http');
          const handler = require('serve-handler');
          const path = require('path');
          
          async function startServer() {
            const server = http.createServer((request, response) => {
              return handler(request, response, {
                public: path.join(__dirname, 'preview')
              });
            });
            
            await new Promise((resolve) => {
              server.listen(8080, () => {
                console.log('Server running at http://localhost:8080');
                resolve();
              });
            });
            
            return server;
          }
          
          async function takeScreenshots() {
            console.log('ðŸ–¼ï¸  Taking cross-browser screenshots...\n');
            
            const browser = await puppeteer.launch({
              headless: 'new',
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });
            
            const viewports = [
              { name: 'Mobile', width: 375, height: 667 },
              { name: 'Tablet', width: 768, height: 1024 },
              { name: 'Desktop', width: 1920, height: 1080 }
            ];
            
            for (const viewport of viewports) {
              console.log(`Taking ${viewport.name} screenshot (${viewport.width}x${viewport.height})...`);
              
              const page = await browser.newPage();
              await page.setViewport(viewport);
              
              try {
                await page.goto('http://localhost:8080/index.html', {
                  waitUntil: 'networkidle2',
                  timeout: 30000
                });
                
                await page.screenshot({
                  path: `screenshot-${viewport.name.toLowerCase()}.png`,
                  fullPage: false
                });
                
                console.log(`âœ… ${viewport.name} screenshot saved`);
              } catch (error) {
                console.error(`âŒ Failed to capture ${viewport.name} screenshot:`, error.message);
              }
              
              await page.close();
            }
            
            await browser.close();
            console.log('\nâœ… Screenshot tests completed!');
          }
          
          (async () => {
            const server = await startServer();
            await takeScreenshots();
            server.close();
          })();
          EOF
      
      - name: Take Screenshots
        run: node take-screenshots.js || true
        continue-on-error: true
      
      - name: Upload Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cross-browser-screenshots
          path: screenshot-*.png
          retention-days: 7

  cleanup-on-close:
    name: Cleanup Preview Branch
    runs-on: ubuntu-latest
    if: github.event.pull_request.state == 'closed'
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Delete Preview Branch
        run: |
          PREVIEW_BRANCH="preview-pr-${{ github.event.pull_request.number }}"
          git push origin --delete $PREVIEW_BRANCH || echo "Preview branch already deleted"

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [build, deploy-preview, lighthouse, cross-browser-screenshots]
    if: always()
    
    steps:
      - name: Summary Report
        run: |
          echo "## ðŸš€ Deployment Preview Summary"
          echo ""
          echo "All deployment tasks completed!"
          echo ""
          echo "### Tasks Performed:"
          echo "- âœ… Build Static Site"
          echo "- âœ… Deploy Preview to GitHub Pages"
          echo "- âœ… Lighthouse Performance Audit"
          echo "- âœ… Cross-Browser Screenshot Tests"
          echo ""
          echo "### Artifacts Available:"
          echo "- Build preview files"
          echo "- Cross-browser screenshots (Mobile, Tablet, Desktop)"
          echo ""
          echo "Check the PR comments for the preview URL!"
