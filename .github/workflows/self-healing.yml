name: Self-Healing & Auto-Recovery

on:
  schedule:
    # Täglich um 06:00 UTC prüfen
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      force_recovery:
        description: 'Force recovery actions'
        required: false
        default: 'false'
        type: boolean

env:
  PYTHON_VERSION: '3.11'

jobs:
  health-check:
    name: System Health Check
    runs-on: ubuntu-latest
    outputs:
      wfs_healthy: ${{ steps.wfs.outputs.healthy }}
      deps_outdated: ${{ steps.deps.outputs.outdated }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: |
          cd backend
          pip install requests OWSLib pip-outdated

      - name: Check NRW WFS Services
        id: wfs
        run: |
          cd backend
          python << 'EOF'
          import requests
          import json
          import os

          services = {
              "alkis": "https://www.wfs.nrw.de/geobasis/wfs_nw_alkis_vereinfacht",
              "laerm": "https://www.wfs.nrw.de/umwelt/laermkartierung"
          }

          all_healthy = True
          results = {}

          for name, url in services.items():
              try:
                  params = {"service": "WFS", "request": "GetCapabilities"}
                  response = requests.get(url, params=params, timeout=30)
                  healthy = response.status_code == 200
                  results[name] = {"healthy": healthy, "status": response.status_code}
                  if not healthy:
                      all_healthy = False
              except Exception as e:
                  results[name] = {"healthy": False, "error": str(e)}
                  all_healthy = False

          print(json.dumps(results, indent=2))

          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"healthy={'true' if all_healthy else 'false'}\n")
          EOF

      - name: Check Outdated Dependencies
        id: deps
        run: |
          cd backend
          pip install pip-outdated
          outdated=$(pip list --outdated --format=json | python -c "import sys,json; d=json.load(sys.stdin); print('true' if len(d) > 5 else 'false')")
          echo "outdated=$outdated" >> $GITHUB_OUTPUT
          pip list --outdated

  auto-fix-deps:
    name: Auto-Fix Dependencies
    runs-on: ubuntu-latest
    needs: health-check
    if: needs.health-check.outputs.deps_outdated == 'true' || github.event.inputs.force_recovery == 'true'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Update Safe Dependencies
        run: |
          cd backend
          pip install pip-tools

          # Nur Patch-Updates automatisch
          pip-compile --upgrade-package 'requests' \
                      --upgrade-package 'pydantic' \
                      --upgrade-package 'fastapi' \
                      requirements.txt -o requirements.txt

      - name: Create PR for Updates
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore(deps): Auto-update safe dependencies'
          title: '[Self-Healing] Dependency Updates'
          body: |
            ## Automatisches Dependency Update

            Dieses PR wurde automatisch durch den Self-Healing Workflow erstellt.

            ### Änderungen
            - Sichere Patch-Updates für Dependencies

            ### Checklist
            - [ ] CI Tests erfolgreich
            - [ ] Keine Breaking Changes
          branch: self-healing/dep-updates
          delete-branch: true
          labels: |
            dependencies
            automated

  cache-warmup:
    name: Cache Warmup
    runs-on: ubuntu-latest
    needs: health-check
    if: needs.health-check.outputs.wfs_healthy == 'true'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: |
          cd backend
          pip install requests OWSLib shapely

      - name: Warm Up WFS Cache
        run: |
          cd backend
          python << 'EOF'
          from integrations.nrw_data_loader import NRWDataLoader
          import json
          from pathlib import Path

          loader = NRWDataLoader(cache_dir=Path("./cache"))

          # Wichtige Bounding Boxes für NRW (Berlin-Region Beispiel)
          test_bboxes = [
              (360000, 5660000, 370000, 5670000),  # Testgebiet 1
          ]

          for bbox in test_bboxes:
              try:
                  # ALKIS Daten laden und cachen
                  print(f"Loading ALKIS for {bbox}...")
                  data = loader.load_alkis_data(bbox=bbox, max_features=100)
                  print(f"  Loaded {len(data)} features")
              except Exception as e:
                  print(f"  Error: {e}")

          print("Cache warmup complete")
          EOF

  notify-failures:
    name: Notify on Failures
    runs-on: ubuntu-latest
    needs: [health-check, auto-fix-deps, cache-warmup]
    if: failure()

    steps:
      - name: Create Issue for Failures
        uses: actions/github-script@v7
        with:
          script: |
            const title = `[Self-Healing] System Health Issues Detected - ${new Date().toISOString().split('T')[0]}`;

            const body = `
            ## Self-Healing Workflow Failure

            Der automatische Health Check hat Probleme festgestellt.

            ### Workflow Run
            - Run ID: ${{ github.run_id }}
            - Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ### Erforderliche Aktionen
            1. Prüfen Sie die WFS-Dienste Verfügbarkeit
            2. Überprüfen Sie die Dependency Updates
            3. Starten Sie den Workflow manuell neu falls nötig

            /cc @Darkness308
            `;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'self-healing'
            });

            const existingIssue = issues.data.find(i => i.title.includes('[Self-Healing]'));

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['self-healing', 'automated', 'bug']
              });
            }
